<app-navbar></app-navbar>

<section class="page">
  <header class="header">
    <h1>Rechercher un covoiturage</h1>
  </header>

  <!-- Formulaire de recherche -->
  <div class="filters">
    <!-- Adresse de départ -->
    <fieldset class="field">
      <legend>Adresse de départ</legend>

      <div class="row">
        <input type="text" inputmode="numeric" placeholder="N°" [value]="depNumero() ?? ''"
               (input)="onNumberInput($event, depNumero)" class="w-20" />

        <input type="text" placeholder="Rue / voie" [value]="depRue()" (input)="onTextInput($event, depRue)"
               class="flex-1" />
      </div>

      <div class="row">
        <input type="text" inputmode="numeric" placeholder="Code postal" [value]="depCp()"
               (input)="onTextInput($event, depCp)" class="w-28" />

        <input type="text" placeholder="Ville" [value]="depVille()" (input)="onTextInput($event, depVille)"
               class="flex-1" />
      </div>
    </fieldset>

    <!-- Adresse d'arrivée -->
    <fieldset class="field">
      <legend>Adresse d'arrivée</legend>

      <div class="row">
        <input type="text" inputmode="numeric" placeholder="N°" [value]="arrNumero() ?? ''"
               (input)="onNumberInput($event, arrNumero)" class="w-20" />

        <input type="text" placeholder="Rue / voie" [value]="arrRue()" (input)="onTextInput($event, arrRue)"
               class="flex-1" />
      </div>

      <div class="row">
        <input type="text" inputmode="numeric" placeholder="Code postal" [value]="arrCp()"
               (input)="onTextInput($event, arrCp)" class="w-28" />

        <input type="text" placeholder="Ville" [value]="arrVille()" (input)="onTextInput($event, arrVille)"
               class="flex-1" />
      </div>
    </fieldset>

    <!-- Date / heure / flexibilité -->
    <fieldset class="field">
      <legend>Quand ?</legend>

      <div class="row">
        <label class="col">
          <span class="label">Date de départ</span>
          <input
            type="date"
            [value]="dateStr()"
            (input)="onTextInput($event, dateStr)"
            [min]="todayStr"
            placeholder="Sélectionnez une date" />
        </label>

        <label class="col">
          <span class="label">Heure</span>
          <input
            type="time"
            [value]="timeStr()"
            (input)="onTextInput($event, timeStr)"
            placeholder="08:00" />
        </label>

        <label class="col">
          <span class="label">Flexibilité (± heures)</span>
          <input
            type="number"
            min="0"
            step="1"
            [value]="flexHeures() ?? ''"
            (input)="onFlexInput($event)"
            placeholder="2" />
        </label>
      </div>
      @if (dateWarn()) {
      <p class="warn-inline">{{ dateWarn() }}</p>
      }
    </fieldset>


    <div class="actions">
      <button type="button" class="btn" (click)="rechercher()" [disabled]="isPastSelected()">Rechercher</button>
    </div>

    @if (errorMsg()) {
    <p class="warn">{{ errorMsg() }}</p>
    }
  </div>

  <!-- Résultats -->
  @if (loading()) {
  <p class="muted">Chargement…</p>
  } @else if (results().length === 0) {
  <p class="muted">Aucune annonce ne correspond aux critères.</p>
  } @else {
  <div class="table-wrap">
    <table class="table">
      <thead>
      <tr>
        <th>Date de départ</th>
        <th>Adresse de départ</th>
        <th>Adresse d'arrivée</th>
        <th>Conducteur</th>
        <th>Places dispo</th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
      @for (a of results(); track a['annonce']?.id) {
      <tr>
        <td>{{ formatHeureDepart(a['annonce'].heureDepart || '') }}</td>
        <td>{{ formatAdresse(a['annonce'].adresseDepart) }}</td>
        <td>{{ formatAdresse(a['annonce'].adresseArrivee) }}</td>
        <td>{{ conducteurName(a['annonce'].id) || '—' }}</td>
        <td>{{ placesDispo(a) }}</td>
        <td class="actions-cell">
          <button
            type="button"
            class="btn-icon"
            (click)="openDetailModal(a)"
            title="Voir les détails">
            ℹ️
          </button>
          <button type="button" class="btn small" (click)="openModale(a)">
            Réserver
          </button>
        </td>
      </tr>
      }
      </tbody>
    </table>
  </div>
  }
</section>

<app-confirm-dialog
  [open]="!!annonceAReserver()"
  [title]="modaleTitle()"
  [message]="modaleContent()"
  confirmLabel="Reserver"
  cancelLabel="Annuler"
  (confirm)="confirmModale()"
  (cancel)="closeModale()">
</app-confirm-dialog>

<app-recherche-annonce-detail-modal
  [isOpen]="showDetailModal()"
  [annonce]="selectedAnnonceDetail()"
  (close)="closeDetailModal()"
  (reserver)="onReserverFromDetail($event)">
</app-recherche-annonce-detail-modal>

<app-footer></app-footer>

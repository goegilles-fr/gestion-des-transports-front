<app-navbar></app-navbar>

<div class="recherche-container">
  <!-- En-t√™te -->
  <div class="recherche-header">
    <h1 class="recherche-title">RECHERCHER UN COVOITURAGE</h1>
  </div>

  <!-- Formulaire de recherche -->
  <form class="recherche-form" (ngSubmit)="rechercher()">
    <!-- Message d'erreur -->
    <div *ngIf="errorMsg()" class="error-message">
      {{ errorMsg() }}
    </div>

    <!-- Ligne unique avec tous les champs -->
    <div class="form-row">
      <!-- Ville de d√©part -->
      <div class="field-group">
        <label class="field-label">Ville de d√©part</label>
        <app-autocomplete-ville [villes]="villesDisponibles()" [value]="villeDepart()"
          (valueChange)="villeDepart.set($event)" placeholder="Entrez une ville">
        </app-autocomplete-ville>
      </div>

      <!-- Bouton d'√©change -->
      <button type="button" class="btn-exchange" (click)="echangerVilles()" title="√âchanger les villes">
        üîÑ
      </button>

      <!-- Ville d'arriv√©e -->
      <div class="field-group">
        <label class="field-label">Ville d'arriv√©e</label>
        <app-autocomplete-ville [villes]="villesDisponibles()" [value]="villeArrivee()"
          (valueChange)="villeArrivee.set($event)" placeholder="Entrez une ville">
        </app-autocomplete-ville>
      </div>

      <!-- Date -->
      <div class="field-group">
        <label class="field-label">Date de d√©part</label>
        <input type="date" class="form-input" [value]="dateStr()" (input)="dateStr.set($any($event.target).value)"
          [min]="todayStr" />
        <small *ngIf="dateWarn()" style="color: #c00; font-size: 12px;">{{ dateWarn() }}</small>
      </div>
    </div>

    <!-- Bouton de recherche -->
    <button type="submit" class="btn-rechercher" [disabled]="loading() || !!dateWarn()">
      {{ loading() ? 'Recherche en cours...' : 'Rechercher' }}
    </button>
  </form>

  <!-- Section des r√©sultats -->
  <div *ngIf="results().length > 0" class="results-section">
    <h2 class="results-title">R√©sultats de la recherche ({{ results().length }})</h2>

    <div class="annonces-table-container">
      <div class="annonces-table">
        <table>
          <thead>
            <tr>
              <th>Heure de d√©part</th>
              <th>Adresse de d√©part</th>
              <th>Adresse d'arriv√©e</th>
              <th>Conducteur</th>
              <th>Places dispo</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of paginatedResults()">
              <td>{{ formatHeureDepart(item.annonce.heureDepart) }}</td>
              <td>{{ formatAdresse(item.annonce.adresseDepart) }}</td>
              <td>{{ formatAdresse(item.annonce.adresseArrivee) }}</td>
              <td>{{ conducteurName(item.annonce.id) || '‚Äî' }}</td>
              <td>
                <span class="badge-places" [class.complet]="placesDispo(item) === 0">
                  {{ placesDispo(item) }}
                </span>
              </td>
              <td class="actions-cell">
                <button type="button" class="btn-icon" (click)="openDetailModal(item)" title="Voir les d√©tails">
                  ‚ÑπÔ∏è
                </button>
                <button type="button" class="btn-reserver" (click)="openModale(item)"
                  [disabled]="placesDispo(item) === 0">
                  R√©server
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <button type="button" class="pager" (click)="previousPage()" [disabled]="currentPage() === 1">Pr√©c√©dent</button>
      <span class="pager__info">Page {{ currentPage() }} / {{ totalPages() }}</span>
      <button type="button" class="pager" (click)="nextPage()" [disabled]="currentPage() === totalPages()">Suivant</button>
    </div>
  </div>

  <!-- Message si aucun r√©sultat -->
  <div *ngIf="!loading() && results().length === 0 && (villeDepart() || villeArrivee() || dateStr())"
    class="no-results">
    <p><strong>Aucun covoiturage trouv√©</strong></p>
    <p>Essayez de modifier vos crit√®res de recherche.</p>
  </div>
</div>

<app-footer></app-footer>

<!-- Modale de confirmation -->
<app-confirm-dialog [open]="!!annonceAReserver()" [title]="modaleTitle()" [content]="modaleContent()"
  (confirm)="confirmModale()" (cancel)="closeModale()">
</app-confirm-dialog>

<!-- Modale de d√©tail -->
<app-recherche-annonce-detail-modal [isOpen]="showDetailModal()" [annonce]="selectedAnnonceDetail()"
  (close)="closeDetailModal()" (reserver)="onReserverFromDetail($event)">
</app-recherche-annonce-detail-modal>